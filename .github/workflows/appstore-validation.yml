name: App Store Validation

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number (leave empty for auto-increment)'
        required: false
        type: string
      skip_tests:
        description: 'Skip test suite (faster validation)'
        required: false
        default: false
        type: boolean

# Only one validation at a time
concurrency:
  group: appstore-validation
  cancel-in-progress: false

env:
  SCHEME: UnaMentis
  DESTINATION: 'platform=iOS Simulator,name=iPhone 15 Pro'

jobs:
  # ============================================
  # Stage 1: Pre-flight Checks
  # ============================================
  preflight:
    name: Pre-flight Checks
    runs-on: macos-14
    outputs:
      version: ${{ steps.version.outputs.version }}
      build: ${{ steps.version.outputs.build }}

    steps:
    - uses: actions/checkout@v4

    - name: Extract Version Info
      id: version
      run: |
        # Extract from Info.plist
        VERSION=$(plutil -extract CFBundleShortVersionString raw UnaMentis/Info.plist 2>/dev/null || echo "1.0")

        if [ -n "${{ inputs.build_number }}" ]; then
          BUILD="${{ inputs.build_number }}"
        else
          BUILD=$(plutil -extract CFBundleVersion raw UnaMentis/Info.plist 2>/dev/null || echo "1")
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build=$BUILD" >> $GITHUB_OUTPUT
        echo "## Version Info" >> $GITHUB_STEP_SUMMARY
        echo "- Version: $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- Build: $BUILD" >> $GITHUB_STEP_SUMMARY

    - name: Check Required Files
      id: files
      run: |
        echo "## Required Files Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| File | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

        MISSING=0

        # Check Privacy Manifest
        if [ -f "UnaMentis/PrivacyInfo.xcprivacy" ]; then
          echo "| PrivacyInfo.xcprivacy | ✅ Found |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| PrivacyInfo.xcprivacy | ❌ MISSING |" >> $GITHUB_STEP_SUMMARY
          MISSING=1
        fi

        # Check Info.plist
        if [ -f "UnaMentis/Info.plist" ]; then
          echo "| Info.plist | ✅ Found |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Info.plist | ❌ MISSING |" >> $GITHUB_STEP_SUMMARY
          MISSING=1
        fi

        # Check Entitlements
        if [ -f "UnaMentis/UnaMentis.entitlements" ]; then
          echo "| Entitlements | ✅ Found |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Entitlements | ❌ MISSING |" >> $GITHUB_STEP_SUMMARY
          MISSING=1
        fi

        # Check App Icons
        if [ -d "UnaMentis/Assets.xcassets/AppIcon.appiconset" ]; then
          ICON_COUNT=$(ls UnaMentis/Assets.xcassets/AppIcon.appiconset/*.png 2>/dev/null | wc -l | tr -d ' ')
          if [ "$ICON_COUNT" -gt 0 ]; then
            echo "| App Icons | ✅ Found ($ICON_COUNT images) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| App Icons | ⚠️ No PNG files found |" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "| App Icons | ⚠️ AppIcon.appiconset not found |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ $MISSING -eq 1 ]; then
          echo ""
          echo "❌ **Critical files missing - cannot proceed with App Store submission**" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Validate Privacy Manifest
      run: |
        echo "## Privacy Manifest Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check XML validity
        if plutil -lint UnaMentis/PrivacyInfo.xcprivacy > /dev/null 2>&1; then
          echo "✅ Privacy manifest is valid XML" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Privacy manifest has invalid XML" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        # Check tracking declaration
        TRACKING=$(plutil -extract NSPrivacyTracking raw UnaMentis/PrivacyInfo.xcprivacy 2>/dev/null || echo "not set")
        echo "- NSPrivacyTracking: $TRACKING" >> $GITHUB_STEP_SUMMARY

        # Check API types
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Declared API Types" >> $GITHUB_STEP_SUMMARY
        plutil -extract NSPrivacyAccessedAPITypes json UnaMentis/PrivacyInfo.xcprivacy 2>/dev/null | python3 -c "
        import json, sys
        try:
            apis = json.load(sys.stdin)
            for api in apis:
                api_type = api.get('NSPrivacyAccessedAPIType', 'Unknown')
                reasons = api.get('NSPrivacyAccessedAPITypeReasons', [])
                print(f'- {api_type}: {reasons}')
        except:
            print('Could not parse API types')
        " >> $GITHUB_STEP_SUMMARY || echo "Could not parse" >> $GITHUB_STEP_SUMMARY

    - name: Check Info.plist Requirements
      run: |
        echo "## Info.plist Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Key | Value | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|-------|--------|" >> $GITHUB_STEP_SUMMARY

        # Required keys
        for key in NSMicrophoneUsageDescription NSSpeechRecognitionUsageDescription CFBundleDisplayName CFBundleIdentifier; do
          VALUE=$(plutil -extract "$key" raw UnaMentis/Info.plist 2>/dev/null || echo "NOT SET")
          if [ "$VALUE" != "NOT SET" ] && [ -n "$VALUE" ]; then
            # Truncate long values
            DISPLAY_VALUE="${VALUE:0:50}"
            [ ${#VALUE} -gt 50 ] && DISPLAY_VALUE="${DISPLAY_VALUE}..."
            echo "| $key | $DISPLAY_VALUE | ✅ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| $key | - | ❌ Missing |" >> $GITHUB_STEP_SUMMARY
          fi
        done

  # ============================================
  # Stage 2: Build & Test
  # ============================================
  build-and-test:
    name: Build & Test
    runs-on: macos-14
    needs: preflight

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode 16
      run: sudo xcode-select -s /Applications/Xcode_16.app

    - name: Show Build Environment
      run: |
        echo "## Build Environment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Xcode | $(xcodebuild -version | head -1) |" >> $GITHUB_STEP_SUMMARY
        echo "| Swift | $(swift --version | head -1) |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | $(sw_vers -productVersion) |" >> $GITHUB_STEP_SUMMARY

    - name: Install Tools
      run: brew install xcbeautify

    - name: Cache SPM Packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build for Release
      run: |
        set -o pipefail
        xcodebuild build \
          -scheme ${{ env.SCHEME }} \
          -destination '${{ env.DESTINATION }}' \
          -configuration Release \
          -skipPackagePluginValidation \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | xcbeautify --renderer github-actions

        echo "## Build Result" >> $GITHUB_STEP_SUMMARY
        echo "✅ Release build successful" >> $GITHUB_STEP_SUMMARY

    - name: Run Test Suite
      if: inputs.skip_tests != true
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme ${{ env.SCHEME }} \
          -destination '${{ env.DESTINATION }}' \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults.xcresult \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | xcbeautify --renderer github-actions

    - name: Generate Test Report
      if: inputs.skip_tests != true && always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -d "TestResults.xcresult" ]; then
          xcrun xcresulttool get --path TestResults.xcresult --format json 2>/dev/null | python3 -c "
        import json, sys
        try:
            data = json.load(sys.stdin)
            metrics = data.get('metrics', {})
            tests = metrics.get('testsCount', {}).get('_value', 'N/A')
            failures = metrics.get('testsFailedCount', {}).get('_value', '0')
            print(f'| Metric | Value |')
            print(f'|--------|-------|')
            print(f'| Total Tests | {tests} |')
            print(f'| Failures | {failures} |')
            status = '✅ All Passed' if str(failures) == '0' else '❌ Some Failed'
            print(f'| Status | {status} |')
        except Exception as e:
            print(f'Could not parse: {e}')
        " >> $GITHUB_STEP_SUMMARY || echo "Could not parse test results" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Test Results
      if: inputs.skip_tests != true && always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults.xcresult
        retention-days: 30

  # ============================================
  # Stage 3: Static Analysis
  # ============================================
  static-analysis:
    name: Static Analysis
    runs-on: macos-14
    needs: preflight

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode 16
      run: sudo xcode-select -s /Applications/Xcode_16.app

    - name: Run Xcode Analyze
      run: |
        set -o pipefail
        xcodebuild analyze \
          -scheme ${{ env.SCHEME }} \
          -destination '${{ env.DESTINATION }}' \
          -configuration Release \
          -skipPackagePluginValidation \
          CODE_SIGNING_ALLOWED=NO \
          CLANG_ANALYZER_OUTPUT=plist-html \
          CLANG_ANALYZER_OUTPUT_DIR=AnalysisResults \
          2>&1 | grep -E "(warning:|error:|note:)" || true

        echo "## Static Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Count issues
        if [ -d "AnalysisResults" ]; then
          ISSUE_COUNT=$(find AnalysisResults -name "*.plist" | wc -l | tr -d ' ')
          if [ "$ISSUE_COUNT" -gt 0 ]; then
            echo "⚠️ Found $ISSUE_COUNT potential issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No issues found" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "✅ No issues found" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check for Hardcoded Secrets
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Security Scan" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Look for potential secrets (excluding test files and docs)
        SECRETS_FOUND=0

        # Check for API key patterns
        if grep -rE "(sk-[a-zA-Z0-9]{20,}|AKIA[0-9A-Z]{16})" --include="*.swift" UnaMentis/ 2>/dev/null | grep -v "Test" | grep -v "Mock"; then
          echo "⚠️ Potential hardcoded API keys found" >> $GITHUB_STEP_SUMMARY
          SECRETS_FOUND=1
        fi

        # Check for password patterns
        if grep -rE "password\s*=\s*[\"'][^\"']+[\"']" --include="*.swift" UnaMentis/ 2>/dev/null | grep -v "Test"; then
          echo "⚠️ Potential hardcoded passwords found" >> $GITHUB_STEP_SUMMARY
          SECRETS_FOUND=1
        fi

        if [ $SECRETS_FOUND -eq 0 ]; then
          echo "✅ No hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check Debug Code in Release
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Debug Code Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Look for debug prints that might leak to production
        DEBUG_ISSUES=0

        # Check for print statements outside DEBUG blocks
        PRINT_COUNT=$(grep -rn "print(" --include="*.swift" UnaMentis/ 2>/dev/null | grep -v "#if DEBUG" | grep -v "// DEBUG" | wc -l | tr -d ' ')
        if [ "$PRINT_COUNT" -gt 10 ]; then
          echo "⚠️ $PRINT_COUNT print() statements found (consider using Logger)" >> $GITHUB_STEP_SUMMARY
          DEBUG_ISSUES=1
        fi

        if [ $DEBUG_ISSUES -eq 0 ]; then
          echo "✅ No concerning debug code patterns" >> $GITHUB_STEP_SUMMARY
        fi

  # ============================================
  # Stage 4: Archive Validation
  # ============================================
  archive-validation:
    name: Archive Validation
    runs-on: macos-14
    needs: [preflight, build-and-test]

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode 16
      run: sudo xcode-select -s /Applications/Xcode_16.app

    - name: Install xcbeautify
      run: brew install xcbeautify

    - name: Cache SPM Packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}

    - name: Create Archive
      run: |
        set -o pipefail
        xcodebuild archive \
          -scheme ${{ env.SCHEME }} \
          -destination 'generic/platform=iOS' \
          -archivePath build/UnaMentis.xcarchive \
          -configuration Release \
          -skipPackagePluginValidation \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="-" \
          2>&1 | xcbeautify --renderer github-actions

        echo "## Archive Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Show archive info
        if [ -d "build/UnaMentis.xcarchive" ]; then
          echo "✅ Archive created successfully" >> $GITHUB_STEP_SUMMARY

          # Get app size
          APP_SIZE=$(du -sh build/UnaMentis.xcarchive/Products/Applications/*.app 2>/dev/null | cut -f1)
          echo "- App Size: $APP_SIZE" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Validate Archive Structure
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Archive Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        ARCHIVE_PATH="build/UnaMentis.xcarchive"
        APP_PATH="$ARCHIVE_PATH/Products/Applications/UnaMentis.app"

        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

        # Check Info.plist in app
        if [ -f "$APP_PATH/Info.plist" ]; then
          echo "| App Info.plist | ✅ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| App Info.plist | ❌ |" >> $GITHUB_STEP_SUMMARY
        fi

        # Check PrivacyInfo
        if [ -f "$APP_PATH/PrivacyInfo.xcprivacy" ]; then
          echo "| Privacy Manifest in App | ✅ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Privacy Manifest in App | ⚠️ May need bundle resource |" >> $GITHUB_STEP_SUMMARY
        fi

        # Check for required frameworks
        if [ -d "$APP_PATH/Frameworks" ]; then
          FRAMEWORK_COUNT=$(ls "$APP_PATH/Frameworks" 2>/dev/null | wc -l | tr -d ' ')
          echo "| Embedded Frameworks | ✅ ($FRAMEWORK_COUNT) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Embedded Frameworks | ℹ️ None |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: archive
        path: build/UnaMentis.xcarchive
        retention-days: 7

  # ============================================
  # Stage 5: Generate Report
  # ============================================
  generate-report:
    name: Generate Validation Report
    runs-on: ubuntu-latest
    needs: [preflight, build-and-test, static-analysis, archive-validation]
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Generate Final Report
      env:
        VERSION: ${{ needs.preflight.outputs.version }}
        BUILD: ${{ needs.preflight.outputs.build }}
        PREFLIGHT: ${{ needs.preflight.result }}
        BUILD_TEST: ${{ needs.build-and-test.result }}
        ANALYSIS: ${{ needs.static-analysis.result }}
        ARCHIVE: ${{ needs.archive-validation.result }}
      run: |
        mkdir -p validation-reports

        cat > validation-reports/validation-report.md << 'REPORT_EOF'
        # App Store Validation Report

        **Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        **Version:** $VERSION ($BUILD)
        **Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

        ## Validation Summary

        | Stage | Result |
        |-------|--------|
        | Pre-flight Checks | $PREFLIGHT |
        | Build & Test | $BUILD_TEST |
        | Static Analysis | $ANALYSIS |
        | Archive Validation | $ARCHIVE |

        ## Overall Status

        REPORT_EOF

        # Determine overall status
        if [ "$PREFLIGHT" = "success" ] && [ "$BUILD_TEST" = "success" ] && [ "$ANALYSIS" = "success" ] && [ "$ARCHIVE" = "success" ]; then
          echo "✅ **READY FOR TESTFLIGHT**" >> validation-reports/validation-report.md
          echo "" >> validation-reports/validation-report.md
          echo "All validation checks passed. The app is ready for TestFlight upload." >> validation-reports/validation-report.md
        else
          echo "❌ **NOT READY - Issues Found**" >> validation-reports/validation-report.md
          echo "" >> validation-reports/validation-report.md
          echo "Review the failed stages above and fix issues before submission." >> validation-reports/validation-report.md
        fi

        cat >> validation-reports/validation-report.md << 'REPORT_EOF'

        ## Next Steps

        1. Download the archive artifact from this workflow run
        2. Open in Xcode Organizer
        3. Sign with your distribution certificate
        4. Upload to App Store Connect
        5. Submit for TestFlight review

        ## Checklist Before Upload

        - [ ] Privacy policy URL configured in App Store Connect
        - [ ] App description and keywords set
        - [ ] Screenshots uploaded for all device sizes
        - [ ] Age rating questionnaire completed
        - [ ] Contact information verified

        ---
        *Generated by App Store Validation Workflow*
        REPORT_EOF

        # Also output to summary
        cat validation-reports/validation-report.md >> $GITHUB_STEP_SUMMARY

    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: validation-report
        path: validation-reports/
        retention-days: 30
