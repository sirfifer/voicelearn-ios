# CLAUDE.md

This file provides guidance to Claude Code when working with the UnaMentis Web Client.

## Project Overview

UnaMentis Web Client is a Next.js voice AI tutoring application. It enables 60-90+ minute voice-based learning sessions with sub-500ms latency, matching the iOS app's capabilities for web browsers.

## Server Ecosystem Integration

This is **part of the UnaMentis server ecosystem**, not a standalone application:

```
server/
├── management/      # Backend API (port 8766) - auth, data, plugins
├── web/             # Operations Console (port 3000) - admin UI
├── web-client/      # THIS PROJECT - voice tutoring client
├── importers/       # Curriculum import plugins
├── server-manager/  # macOS menu bar orchestrator
└── database/        # PostgreSQL/SQLite layer
```

**Key relationships**:
- All auth requests proxy to Management API (8766)
- All data (curricula, sessions) comes from Management API
- Ephemeral tokens for OpenAI Realtime generated by Management API
- Logging and metrics sent to Management API
- This server handles: UI, voice pipeline, WebRTC connection

## Tech Stack

- **Framework**: Next.js 15+ with App Router
- **Language**: TypeScript 5 (strict mode)
- **Styling**: Tailwind CSS 4
- **State**: React Context + custom hooks
- **Voice**: OpenAI Realtime API (WebRTC primary), Web Audio API
- **Math**: KaTeX for LaTeX rendering
- **Maps**: Leaflet or Mapbox GL

## Quick Commands

```bash
# Development
npm run dev          # Start dev server (http://localhost:3000)
npm run build        # Production build
npm run lint         # Run ESLint
npm run type-check   # TypeScript check

# Testing (when implemented)
npm run test         # Run tests
npm run test:watch   # Watch mode
```

## Key Architecture

### Provider Abstraction

All voice services use TypeScript interfaces for provider abstraction:

```typescript
// STT Provider
interface STTProvider {
  startStreaming(audioFormat: AudioFormat): AsyncIterable<STTResult>;
  sendAudio(buffer: ArrayBuffer): Promise<void>;
  stopStreaming(): Promise<void>;
}

// TTS Provider
interface TTSProvider {
  synthesize(text: string): AsyncIterable<AudioChunk>;
  configure(config: TTSConfig): void;
}

// LLM Provider
interface LLMProvider {
  streamCompletion(messages: Message[], config: LLMConfig): AsyncIterable<LLMToken>;
}
```

### Session State Machine

Match iOS session states exactly:
- `idle` - Not active
- `userSpeaking` - Listening to user
- `processingUserUtterance` - STT result received
- `aiThinking` - LLM generating response
- `aiSpeaking` - TTS playback in progress
- `interrupted` - Tentative barge-in
- `paused` - Frozen state
- `error` - Error occurred

### Component Hierarchy

```
App
├── AuthProvider
├── SessionProvider
│   └── ProviderManager (STT/TTS/LLM selection)
└── Layout
    ├── Header (session status, timer, controls)
    ├── MainContent
    │   ├── TranscriptPanel (60%)
    │   └── VisualPanel (40%)
    └── TabBar (Session, Curriculum, Todo, History, Settings)
```

## Server Integration

### Management API

Base URL: `http://localhost:8766`

Key endpoints:
- `POST /api/auth/login` - Authentication
- `GET /api/curricula` - List curricula
- `GET /api/curricula/{id}/full-with-assets` - Full curriculum with assets
- `POST /api/logs` - Send client logs
- `POST /api/metrics` - Send metrics

See `docs/API_REFERENCE.md` for complete documentation.

### Authentication Flow

1. Login with email/password + device info
2. Store refresh token securely
3. Use access token (JWT, 15 min) for API calls
4. Refresh before expiry

## Performance Requirements

- **Voice Latency**: <500ms median end-to-end
- **First Token**: <300ms LLM TTFT
- **TTS Playback**: Sentence-level streaming with prefetch
- **Memory**: <100MB growth over 90 minutes

## Coding Conventions

### TypeScript

- Use strict mode
- Prefer interfaces over types for objects
- Use discriminated unions for state
- Export types from dedicated files in `types/`

### React

- Functional components with hooks
- Use React Context for global state
- Custom hooks for reusable logic
- Lazy load heavy components (maps, charts)

### Styling

- Tailwind CSS utility classes
- No separate CSS files
- Use `clsx` + `tailwind-merge` for conditional classes
- Mobile-first responsive design

### File Naming

- Components: `PascalCase.tsx`
- Hooks: `useCamelCase.ts`
- Utilities: `camelCase.ts`
- Types: `types.ts` or `*.types.ts`

## Key Documentation

| Document | Purpose |
|----------|---------|
| `WEB_CLIENT_TDD.md` | Complete technical design |
| `BOOTSTRAP.md` | Phased implementation guide |
| `PARALLEL_DEVELOPMENT.md` | Guide for parallel Claude Code instances |
| `docs/API_REFERENCE.md` | Server API (70+ endpoints) |
| `docs/UMCF_SPECIFICATION.md` | Curriculum format |
| `docs/PROVIDER_GUIDE.md` | Voice provider integration |
| `docs/AUTHENTICATION.md` | Auth flows |
| `docs/WEBSOCKET_PROTOCOL.md` | Real-time protocols |

## Parallel Development

This project supports parallel development with multiple Claude Code instances. See `PARALLEL_DEVELOPMENT.md` for:
- Directory ownership per track
- Complete prompts for each parallel instance
- Safety boundaries to prevent conflicts

## Definition of Done

Before marking any feature complete:

1. Code compiles without TypeScript errors
2. `npm run lint` passes
3. Responsive design works on desktop and mobile
4. Error states are handled gracefully
5. Loading states provide user feedback

## Writing Style

- No em dashes or en dashes as sentence interrupters
- Use commas for parenthetical phrases
- Be concise and direct
- Use active voice
