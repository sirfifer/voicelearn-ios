#!/bin/bash
# UnaMentis Pre-Push Hook
# This hook runs quick tests before allowing pushes.
# Install with: ./scripts/install-hooks.sh

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# =============================================================================
# Bypass Logging
# =============================================================================
# Log directory for hook audit trail
HOOK_LOG_DIR="${HOME}/.unamentis/hook-logs"
mkdir -p "$HOOK_LOG_DIR"

# Log hook execution
log_hook_execution() {
    local status=$1
    local log_file="${HOOK_LOG_DIR}/pre-push.log"
    local timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
    local branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    local remote=${1:-origin}

    # Rotate log if over 1MB
    if [ -f "$log_file" ] && [ $(stat -f%z "$log_file" 2>/dev/null || stat -c%s "$log_file" 2>/dev/null || echo 0) -gt 1048576 ]; then
        mv "$log_file" "${log_file}.1"
    fi

    echo "${timestamp}|${status}|${branch}|$(whoami)|$$" >> "$log_file"
}

# Log hook start
log_hook_execution "STARTED"

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Get the project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

# Run quick tests
if [ -f "scripts/test-quick.sh" ]; then
    echo -e "\n${YELLOW}Running quick tests...${NC}"
    ./scripts/test-quick.sh || {
        log_hook_execution "FAILED"
        echo -e "${RED}Quick tests failed. Please fix before pushing.${NC}"
        echo -e "${YELLOW}Tip: You can bypass this check with 'git push --no-verify' (not recommended)${NC}"
        echo -e "${YELLOW}Note: Hook bypasses are logged for audit purposes.${NC}"
        exit 1
    }
else
    echo -e "${YELLOW}test-quick.sh not found, skipping tests.${NC}"
fi

log_hook_execution "PASSED"
echo -e "\n${GREEN}Pre-push checks passed!${NC}"
exit 0
